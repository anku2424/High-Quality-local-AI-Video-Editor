<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Upload Studio</title>
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}" />
  </head>
  <body>
    <main class="container">
      <h1>Video Upload Studio</h1>
      <p class="subtitle">Your API key is saved. Upload a video to continue.</p>

      <section class="studio-layout">
        <section class="status success">
          <p>Saved API key:</p>
          <code class="key-display">{{ masked_key }}</code>
          <form action="/clear-key" method="post">
            <button type="submit" class="secondary">Clear Key</button>
          </form>
        </section>

        <form action="/upload-video" method="post" enctype="multipart/form-data" class="card">
          <label for="video">Upload Video</label>
          <input id="video" name="video" type="file" accept="video/*" required />
          <button type="submit">Upload Video</button>
        </form>
      </section>

      {% if video_uploaded %}
      <section class="status success">
        <p>video uploaded</p>
      </section>
      {% endif %}

      <section
        id="transcription-processing"
        class="status"
        {% if transcription_status != "processing" %}style="display: none"{% endif %}
      >
        <div class="processing-row">
          <span class="roller" aria-hidden="true"></span>
          <p>generating transcription</p>
        </div>
      </section>

      <section
        id="transcription-error"
        class="status"
        {% if transcription_status != "failed" %}style="display: none"{% endif %}
      >
        <p id="transcription-error-text">{{ transcription_error }}</p>
      </section>

      <section
        id="transcription-result"
        class="status"
        {% if transcription_status != "completed" %}style="display: none"{% endif %}
      >
        <p class="section-title">transcription</p>
        <pre id="transcription-text" class="transcription-text">{{ transcription_text }}</pre>
      </section>

      <section
        id="subtitle-controls"
        class="card"
        {% if transcription_status != "completed" %}style="display: none"{% endif %}
      >
        <p class="result-label section-title">subtitle style</p>
        <form action="/burn-subtitles" method="post" class="subtitle-control-form">
          <label for="font_size">
            Font Size:
            <span id="font_size_value">{{ selected_font_size }}</span>px
          </label>
          <input
            id="font_size"
            name="font_size"
            type="range"
            min="24"
            max="200"
            step="1"
            value="{{ selected_font_size }}"
          />

          <label for="border_size">
            Border Size:
            <span id="border_size_value">{{ selected_border_size }}</span>px
          </label>
          <input
            id="border_size"
            name="border_size"
            type="range"
            min="0"
            max="20"
            step="1"
            value="{{ selected_border_size }}"
          />

          <label>Highlight Colour</label>
          <div class="swatch-grid">
            {% for swatch in color_swatches %}
            <input
              id="highlight_{{ loop.index }}"
              class="swatch-input"
              type="radio"
              name="highlight_color"
              value="{{ swatch }}"
              {% if swatch == selected_highlight_color %}checked{% endif %}
            />
            <label
              class="swatch-box"
              for="highlight_{{ loop.index }}"
              style="--swatch-color: {{ swatch }}"
              title="{{ swatch }}"
            ></label>
            {% endfor %}
          </div>

          <label>Non-highlight Colour</label>
          <div class="swatch-grid">
            {% for swatch in color_swatches %}
            <input
              id="non_highlight_{{ loop.index }}"
              class="swatch-input"
              type="radio"
              name="non_highlight_color"
              value="{{ swatch }}"
              {% if swatch == selected_non_highlight_color %}checked{% endif %}
            />
            <label
              class="swatch-box"
              for="non_highlight_{{ loop.index }}"
              style="--swatch-color: {{ swatch }}"
              title="{{ swatch }}"
            ></label>
            {% endfor %}
          </div>

          <label>Border Colour</label>
          <div class="swatch-grid">
            {% for swatch in color_swatches %}
            <input
              id="border_{{ loop.index }}"
              class="swatch-input"
              type="radio"
              name="border_color"
              value="{{ swatch }}"
              {% if swatch == selected_border_color %}checked{% endif %}
            />
            <label
              class="swatch-box"
              for="border_{{ loop.index }}"
              style="--swatch-color: {{ swatch }}"
              title="{{ swatch }}"
            ></label>
            {% endfor %}
          </div>

          <button id="burn-button" type="submit" {% if subtitle_status == "processing" %}disabled{% endif %}>
            Burn Subtitles
          </button>
        </form>
      </section>

      <section
        id="subtitle-processing"
        class="status"
        {% if subtitle_status != "processing" %}style="display: none"{% endif %}
      >
        <div class="processing-row">
          <span class="roller" aria-hidden="true"></span>
          <p>burning subtitles</p>
        </div>
      </section>

      <section
        id="subtitle-result"
        class="status"
        {% if subtitle_status != "completed" and subtitle_status != "failed" %}style="display: none"{% endif %}
      >
        {% if subtitle_status == "failed" %}
        <p id="subtitle-result-text">{{ subtitle_error }}</p>
        {% else %}
        <p id="subtitle-result-text" class="section-title">subtitles burned</p>
        {% if karaoke_video_path %}
        <video id="subtitle-video" class="preview-video" controls preload="metadata">
          <source src="/{{ karaoke_video_path }}" type="video/mp4" />
        </video>
        {% endif %}
        {% endif %}
      </section>

      <section
        id="broll-section"
        {% if subtitle_status != "completed" %}style="display: none"{% endif %}
      >
        <form action="/upload-broll-folder" method="post" enctype="multipart/form-data" class="card">
          <label for="broll_images">B-roll Folder</label>
          <input
            id="broll_images"
            name="broll_images"
            type="file"
            accept="image/*"
            webkitdirectory
            directory
            multiple
            required
          />
          <button type="submit">Upload B-roll Folder</button>
        </form>

        {% if broll_uploaded %}
        <section class="status success">
          <p>b-roll folder uploaded ({{ broll_image_count }} images)</p>
        </section>
        {% endif %}

        {% if broll_render_error %}
        <section class="status">
          <p>{{ broll_render_error }}</p>
        </section>
        {% endif %}

        {% if broll_rendered_video_path %}
        <section class="status success">
          <p class="section-title">b-roll added</p>
          <video class="preview-video" controls preload="metadata">
            <source src="/{{ broll_rendered_video_path }}" type="video/mp4" />
          </video>
        </section>
        {% endif %}
      </section>
    </main>

    <script>
      (function () {
        const transcriptionProcessingEl = document.getElementById("transcription-processing");
        const transcriptionResultEl = document.getElementById("transcription-result");
        const transcriptionErrorEl = document.getElementById("transcription-error");
        const transcriptionTextEl = document.getElementById("transcription-text");
        const transcriptionErrorTextEl = document.getElementById("transcription-error-text");

        const subtitleControlsEl = document.getElementById("subtitle-controls");
        const subtitleProcessingEl = document.getElementById("subtitle-processing");
        const subtitleResultEl = document.getElementById("subtitle-result");
        const subtitleResultTextEl = document.getElementById("subtitle-result-text");
        const brollSectionEl = document.getElementById("broll-section");
        const burnButtonEl = document.getElementById("burn-button");
        const fontSizeSliderEl = document.getElementById("font_size");
        const fontSizeValueEl = document.getElementById("font_size_value");
        const borderSizeSliderEl = document.getElementById("border_size");
        const borderSizeValueEl = document.getElementById("border_size_value");

        if (fontSizeSliderEl && fontSizeValueEl) {
          fontSizeSliderEl.addEventListener("input", function () {
            fontSizeValueEl.textContent = fontSizeSliderEl.value;
          });
        }

        if (borderSizeSliderEl && borderSizeValueEl) {
          borderSizeSliderEl.addEventListener("input", function () {
            borderSizeValueEl.textContent = borderSizeSliderEl.value;
          });
        }

        function renderSubtitleVideo(path) {
          let videoEl = document.getElementById("subtitle-video");
          if (!path) return;

          if (!videoEl) {
            videoEl = document.createElement("video");
            videoEl.id = "subtitle-video";
            videoEl.className = "preview-video";
            videoEl.controls = true;
            videoEl.preload = "metadata";
            subtitleResultEl.appendChild(videoEl);
          }

          videoEl.innerHTML = "";
          const sourceNode = document.createElement("source");
          sourceNode.src = "/" + path;
          sourceNode.type = "video/mp4";
          videoEl.appendChild(sourceNode);
          videoEl.load();
        }

        function clearSubtitleVideo() {
          const videoEl = document.getElementById("subtitle-video");
          if (videoEl) {
            videoEl.remove();
          }
        }

        function applyState(data) {
          if (data.status === "processing") {
            transcriptionProcessingEl.style.display = "block";
            transcriptionResultEl.style.display = "none";
            transcriptionErrorEl.style.display = "none";
            subtitleControlsEl.style.display = "none";
          } else if (data.status === "completed") {
            transcriptionProcessingEl.style.display = "none";
            transcriptionErrorEl.style.display = "none";
            transcriptionResultEl.style.display = "block";
            subtitleControlsEl.style.display = "block";
            if (transcriptionTextEl) {
              transcriptionTextEl.textContent = data.text || "";
            }
          } else if (data.status === "failed") {
            transcriptionProcessingEl.style.display = "none";
            transcriptionResultEl.style.display = "none";
            subtitleControlsEl.style.display = "none";
            transcriptionErrorEl.style.display = "block";
            if (transcriptionErrorTextEl) {
              transcriptionErrorTextEl.textContent = data.error || "Transcription failed.";
            }
          }

          if (data.subtitle_status === "processing") {
            subtitleProcessingEl.style.display = "block";
            subtitleResultEl.style.display = "none";
            brollSectionEl.style.display = "none";
            clearSubtitleVideo();
            if (burnButtonEl) burnButtonEl.disabled = true;
          } else if (data.subtitle_status === "completed") {
            subtitleProcessingEl.style.display = "none";
            subtitleResultEl.style.display = "block";
            brollSectionEl.style.display = "block";
            if (burnButtonEl) burnButtonEl.disabled = false;
            if (subtitleResultTextEl) {
              subtitleResultTextEl.textContent = "subtitles burned";
            }
            renderSubtitleVideo(data.karaoke_video_path || "");
          } else if (data.subtitle_status === "failed") {
            subtitleProcessingEl.style.display = "none";
            subtitleResultEl.style.display = "block";
            brollSectionEl.style.display = "none";
            clearSubtitleVideo();
            if (burnButtonEl) burnButtonEl.disabled = false;
            if (subtitleResultTextEl) {
              subtitleResultTextEl.textContent = data.subtitle_error || "Subtitle burn failed.";
            }
          } else {
            subtitleProcessingEl.style.display = "none";
            brollSectionEl.style.display = "none";
            if (burnButtonEl) burnButtonEl.disabled = false;
          }
        }

        const shouldPoll =
          transcriptionProcessingEl.style.display !== "none" ||
          subtitleProcessingEl.style.display !== "none";
        if (!shouldPoll) return;

        let pollTimer = null;

        async function pollStatus() {
          try {
            const response = await fetch("/transcription-status", { cache: "no-store" });
            if (!response.ok) return;
            const data = await response.json();
            applyState(data);

            const stillProcessing =
              data.status === "processing" || data.subtitle_status === "processing";
            if (!stillProcessing && pollTimer) {
              clearInterval(pollTimer);
              pollTimer = null;
            }
          } catch (_) {
            // Keep polling while work is running.
          }
        }

        pollTimer = setInterval(pollStatus, 2000);
        pollStatus();
      })();
    </script>
  </body>
</html>
